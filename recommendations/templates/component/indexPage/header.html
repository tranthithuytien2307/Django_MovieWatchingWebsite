<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Header Motchill</title>
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #111;
        color: #fff;
      }

      .site-header {
        background: rgba(0, 0, 0, 0.85);
        padding: 10px 30px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .logo {
        font-size: 24px;
        font-weight: bold;
        color: #f39c12;
        text-decoration: none;
        letter-spacing: 1px;
      }

      /* Thanh t√¨m ki·∫øm */
      .search-bar {
        flex: 1;
        margin: 0 30px;
        display: flex;
        align-items: center;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        padding: 5px 10px;
      }

      .search-bar input {
        flex: 1;
        border: none;
        outline: none;
        padding: 8px;
        background: transparent;
        color: #fff;
        font-size: 14px;
      }

      .search-bar button {
        background: none;
        border: none;
        color: #fff;
        cursor: pointer;
        font-size: 16px;
      }

      /* Menu */
      .navbar {
        display: flex;
        align-items: center;
      }

      .navbar ul {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
      }

      .navbar li {
        position: relative;
        margin: 0 12px;
      }

      .navbar a {
        color: #fff;
        text-decoration: none;
        font-weight: bold;
        padding: 8px 10px;
        display: block;
      }

      /* Dropdown */
      .dropdown-content {
        display: none; /* ·∫©n ƒëi */
        flex-direction: column; /* x·∫øp d·ªçc */
        position: absolute;
        top: 100%;
        left: 0;
        background: #1c1c1c;
        padding: 10px 0;
        border-radius: 8px;
        min-width: 200px;
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.7);
        z-index: 100;
      }

      /* Khi hover v√†o dropdown (th·ªÉ lo·∫°i ho·∫∑c qu·ªëc gia) */
      .dropdown:hover .dropdown-content {
        display: flex; /* hi·ªán ra khi hover */
      }

      .dropdown-content div {
        padding: 8px 16px;
        color: #ddd;
        cursor: pointer;
        font-size: 15px;
        transition: color 0.25s;
      }

      .dropdown-content div:hover {
        color: #f39c12;
        background: #333; /* th√™m background khi hover cho d·ªÖ nh√¨n */
      }

      .login-btn {
        background: #fff;
        color: #000;
        border: none;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: bold;
        cursor: pointer;
        transition: 0.3s;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 4px;
        text-decoration: none;
      }

      .login-btn:hover {
        background: #f39c12;
        color: #fff;
      }

      input:-webkit-autofill,
      input:-webkit-autofill:hover,
      input:-webkit-autofill:focus,
      input:-webkit-autofill:active {
        -webkit-text-fill-color: #fff !important;
        transition: background-color 9999s ease-in-out 0s !important;
      }

      #suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #222;
        border-radius: 8px;
        margin-top: 5px;
        overflow: hidden;
        z-index: 1000;
      }

      #suggestions div {
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #333;
        color: #fff;
      }

      #suggestions div:hover {
        background: #444;
      }
    </style>
    <script>
      function autocomplete() {
        const query = document.getElementById("movie").value;
        if (query.length < 2) {
          document.getElementById("suggestions").innerHTML = "";
          return;
        }
        fetch(`/search/?q=${query}`)
          .then((res) => res.json())
          .then((data) => {
            let list = document.getElementById("suggestions");
            list.innerHTML = "";
            data.forEach((item) => {
              let div = document.createElement("div");
              div.innerHTML = item;
              div.onclick = () => {
                document.getElementById("movie").value = item;
                list.innerHTML = "";
              };
              list.appendChild(div);
            });
          });
      }
      function filterBy(type, id) {
        // T·∫°o URL base l√† trang ch·ªß (index)
        let baseUrl = "{% url 'index' %}";

        // G·∫Øn tham s·ªë t∆∞∆°ng ·ª©ng v√†o query string
        let params = new URLSearchParams(window.location.search);

        // X√≥a query c≈© n·∫øu c√≥
        if (type === "genre") {
          params.delete("country");
          params.set("genre", id);
        } else if (type === "country") {
          params.delete("genre");
          params.set("country", id);
        }

        // ƒêi·ªÅu h∆∞·ªõng sang trang l·ªçc
        window.location.href = `${baseUrl}?${params.toString()}`;
      }
    </script>
  </head>
  <body>
    <header class="site-header">
      <!-- Logo -->
      <a href="{% url 'index' %}" class="logo">Fairy</a>

      <!-- Thanh t√¨m ki·∫øm -->
      <form action="{% url 'recommend' %}" class="search-bar">
        <input
          type="text"
          id="movie"
          name="movie"
          onkeyup="autocomplete()"
          placeholder="T√¨m ki·∫øm phim..."
          required
        />
        <button type="submit">üîç</button>
        <div id="suggestions"></div>
      </form>

      <!-- Menu -->
      <nav class="navbar">
        <ul>
          <!-- Dropdown th·ªÉ lo·∫°i -->
          <li class="dropdown">
            <a href="#">Th·ªÉ Lo·∫°i ‚ñº</a>
            <div class="dropdown-content">
              {% for genre in genres %}
              <div onclick="filterBy('genre', '{{ genre.id }}')">
                {{ genre.name }}
              </div>
              {% empty %}
              <div>Kh√¥ng c√≥ d·ªØ li·ªáu</div>
              {% endfor %}
            </div>
          </li>

          <!-- Dropdown qu·ªëc gia -->
          <li class="dropdown">
            <a href="#">Qu·ªëc Gia ‚ñº</a>
            <div class="dropdown-content">
              {% for country in countries %}
              <div onclick="filterBy('country', '{{ country.id }}')">
                {{ country.name }}
              </div>
              {% empty %}
              <div>Kh√¥ng c√≥ d·ªØ li·ªáu</div>
              {% endfor %}
            </div>
          </li>
        </ul>
      </nav>

      <!-- N√∫t ƒëƒÉng nh·∫≠p ho·∫∑c hi·ªÉn th·ªã user -->
      <div id="user-header"></div>

      <script>
        const userHeader = document.getElementById("user-header");
        const user = JSON.parse(localStorage.getItem("user")); // user = {name, email, avatar}

        if (user) {
          userHeader.innerHTML = `
      <div class="user-dropdown" style="position: relative">
        <button class="login-btn" style="display: flex; align-items: center; gap: 8px">
          <img src="${user.avatar}" alt="avatar" style="width:24px; height:24px; border-radius:50%; object-fit:cover"/>
          <span>${user.name}</span>
        </button>
        <div class="dropdown-logout" style="
          display: none;
          position: absolute;
          top: 110%;
          right: 0;
          background: #1c1c1c;
          border-radius: 8px;
          box-shadow: 0 6px 15px rgba(0,0,0,0.7);
          min-width: 180px;
          z-index: 100;
          padding: 8px 0;
        ">
          <div style="padding: 8px 16px; color:#ddd; font-size:14px;">${user.email}</div>
          <a href="#" id="logout-btn" style="
            display: block;
            padding: 10px 15px;
            color: #fff;
            text-decoration: none;
            font-weight: bold;
            transition: 0.2s;
          " onmouseover="this.style.background='#333'" onmouseout="this.style.background='transparent'">
            Logout
          </a>
        </div>
      </div>
    `;

          const userBtn = userHeader.querySelector(".login-btn");
          const logoutMenu = userHeader.querySelector(".dropdown-logout");
          const logoutBtn = userHeader.querySelector("#logout-btn");

          // Click m·ªü/ƒë√≥ng dropdown
          userBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            logoutMenu.style.display =
              logoutMenu.style.display === "block" ? "none" : "block";
          });

          // Click ngo√†i dropdown ƒë√≥ng
          document.addEventListener("click", () => {
            logoutMenu.style.display = "none";
          });

          // Logout: x√≥a localStorage v√† reload
          logoutBtn.addEventListener("click", (e) => {
            e.preventDefault();
            localStorage.removeItem("user");
            localStorage.removeItem("access_token"); // n·∫øu c√≥
            localStorage.removeItem("is_admin");
            localStorage.removeItem("refresh_token");
            window.location.reload();
          });
        } else {
          // N·∫øu ch∆∞a ƒëƒÉng nh·∫≠p
          userHeader.innerHTML = `
      <a href="/login" class="login-btn" style="display:flex; align-items:center; gap:4px">
        <svg width="20" height="20" viewBox="0 0 32 32" fill="none">
          <path d="..." fill="#374151" />
        </svg>
        <span>ƒêƒÉng Nh·∫≠p</span>
      </a>
    `;
        }
      </script>
    </header>
  </body>
</html>
