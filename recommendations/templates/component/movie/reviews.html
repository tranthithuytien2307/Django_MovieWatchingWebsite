<div class="reviews" style="margin-top: 40px">
  <h3>Đánh giá & Nhận xét</h3>

  <!-- Average rating -->
  <div
    id="review-stats"
    style="margin: 10px 0; font-size: 16px; color: #ffcc00"
  >
    Đang tải thống kê...
  </div>

  <hr style="border-color: #444" />

  <!-- Review list -->
  <div id="review-list">
    <p>Đang tải đánh giá...</p>
  </div>

  <!-- Write review -->
  <div
    class="write-review"
    id="write-review"
    style="margin-top: 20px; display: none"
  >
    <h4>Viết đánh giá của bạn</h4>

    <label>⭐ Rating (1–5):</label>
    <select id="review-rating">
      <option value="1">1 ⭐</option>
      <option value="2">2 ⭐</option>
      <option value="3">3 ⭐</option>
      <option value="4">4 ⭐</option>
      <option value="5" selected>5 ⭐</option>
    </select>

    <br /><br />

    <textarea
      id="review-content"
      rows="4"
      style="
        width: 100%;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid #555;
        background: #0f0f0f;
        color: #fff;
        font-size: 14px;
        resize: vertical;
        margin-bottom: 15px;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.5);
      "
      placeholder="Viết cảm nhận của bạn..."
    ></textarea>

    <button
      id="submit-review"
      style="
        padding: 10px 20px;
        background: linear-gradient(90deg, #e53935, #d32f2f);
        color: #fff;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        font-size: 14px;
        transition: all 0.2s ease;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
      "
      onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(0,0,0,0.5)';"
      onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.4)';"
    >
      Gửi đánh giá
    </button>
  </div>

  <!-- Login prompt -->
  <p id="login-prompt" style="margin-top: 20px">
    <a href="/login" style="color: #4fc3f7">Đăng nhập</a> để viết đánh giá.
  </p>
</div>

<script>
  const movieId = "{{ movie.id }}";
  const token = localStorage.getItem("access_token");

  // Hiển thị form hoặc prompt tùy token
  if (token) {
    document.getElementById("write-review").style.display = "block";
    document.getElementById("login-prompt").style.display = "none";
  } else {
    document.getElementById("write-review").style.display = "none";
    document.getElementById("login-prompt").style.display = "block";
  }

  // Load danh sách review
  async function loadReviews() {
    const res = await fetch(`/movies/${movieId}/reviews/`);
    const data = await res.json();

    const container = document.getElementById("review-list");

    if (!data.length) {
      container.innerHTML = "<p>Chưa có đánh giá nào.</p>";
      return;
    }

    container.innerHTML = data
      .map(
        (rv) => `
      <div style="padding:10px 0;border-bottom:1px solid #444;">
        <b>${rv.userName}</b> - ⭐ ${rv.rating}
        <p>${rv.content}</p>
      </div>
    `
      )
      .join("");
  }

  // Load thống kê rating
  async function loadStats() {
    const res = await fetch(`/movies/${movieId}/rating/`);
    const data = await res.json();

    document.getElementById(
      "review-stats"
    ).textContent = `⭐ ${data.average_rating}/5 — ${data.total_reviews} đánh giá`;
  }

  loadReviews();
  loadStats();

  // Gửi review
  const btn = document.getElementById("submit-review");
  if (btn) {
    btn.addEventListener("click", async () => {
      const rating = document.getElementById("review-rating").value;
      const content = document.getElementById("review-content").value;

      if (!token) {
        alert("Bạn cần đăng nhập để viết đánh giá.");
        return;
      }

      const res = await fetch("/reviews/create/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({
          movie: movieId,
          rating,
          content,
        }),
      });

      if (res.ok) {
        alert("Đánh giá thành công!");
        document.getElementById("review-content").value = "";
        loadReviews();
        loadStats();
      } else {
        const data = await res.json();
        alert("Lỗi: " + JSON.stringify(data));
      }
    });
  }
</script>
